<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>CPT Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: system-ui, -apple-system, sans-serif;
  text-align: center;
  margin-top: 40px;
}
#stim {
  font-size: 72px;
  height: 120px;
  margin: 30px;
}
button {
  font-size: 18px;
  padding: 12px 18px;
  margin: 6px;
}
#hint {
  margin-top: 16px;
  color: #444;
}
#log {
  margin-top: 24px;
  font-size: 13px;
  white-space: pre-wrap;
  text-align: left;
  max-width: 900px;
  margin-left: auto;
  margin-right: auto;
  border: 1px solid #ddd;
  padding: 12px;
  border-radius: 8px;
}
</style>
</head>

<body>

<h2>CPT Test</h2>

<div>
  <button id="startBtn">시작</button>
  <button id="respBtn" disabled>반응 (Space)</button>
</div>

<div id="stim">+</div>
<div id="hint">시작 버튼을 누르세요</div>
<div id="log"></div>

<script>
// =========================
// 설정
// =========================
const CFG = {
  blocks: 2,
  trialsPerBlock: 20,
  targetProb: 0.7,
  stimMs: 500,
  isiMs: 800
};

// =========================
// 상태
// =========================
const State = {
  phase: "idle",
  block: 0,
  trial: 0,
  trials: [],
  currentIsTarget: false,
  stimOnAt: 0
};

// =========================
// UI
// =========================
const stimEl = document.getElementById("stim");
const hintEl = document.getElementById("hint");
const logEl  = document.getElementById("log");
const startBtn = document.getElementById("startBtn");
const respBtn  = document.getElementById("respBtn");

// =========================
// Presigned URL → S3 업로드
// =========================
async function getPresignedPutUrl(contentType="application/json") {
  const r = await fetch("/api/get-presigned-url", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ contentType })
  });
  if (!r.ok) throw new Error("presign_fail_" + r.status);
  return await r.json(); // { url, key }
}

async function putJsonToS3(url, data) {
  const r = await fetch(url, {
    method: "PUT",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(data)
  });
  if (!r.ok) throw new Error("s3_put_" + r.status);
}

// =========================
// CPT 로직
// =========================
function randTarget() {
  return Math.random() < CFG.targetProb;
}

function showStim(isTarget) {
  stimEl.textContent = isTarget ? "X" : "O";
  State.stimOnAt = performance.now();
}

function clearStim() {
  stimEl.textContent = "+";
}

function nextTrial() {
  if (State.trial >= CFG.trialsPerBlock) {
    nextBlock();
    return;
  }

  State.currentIsTarget = randTarget();
  showStim(State.currentIsTarget);
  State.phase = "stim";

  setTimeout(() => {
    clearStim();
    State.phase = "isi";

    State.trials.push({
      block: State.block,
      trial: State.trial,
      isTarget: State.currentIsTarget,
      rt: null,
      pressed: false
    });

    State.trial++;
    setTimeout(nextTrial, CFG.isiMs);

  }, CFG.stimMs);
}

function nextBlock() {
  State.block++;
  if (State.block > CFG.blocks) {
    finishTest();
    return;
  }
  State.trial = 0;
  hintEl.textContent = "Block " + State.block + " 시작";
  setTimeout(nextTrial, 1000);
}

function recordResponse() {
  if (State.phase !== "stim") return;
  const rt = performance.now() - State.stimOnAt;
  const last = State.trials[State.trials.length - 1];
  if (last && last.rt === null) {
    last.rt = Math.round(rt);
    last.pressed = true;
  }
}

// =========================
// 완료 → S3 업로드
// =========================
async function finishTest() {
  State.phase = "finished";
  respBtn.disabled = true;
  hintEl.textContent = "완료 — 업로드 중…";

  const payload = {
    savedAt: new Date().toISOString(),
    config: CFG,
    trials: State.trials,
    ua: navigator.userAgent
  };

  try {
    const { url, key } = await getPresignedPutUrl();
    await putJsonToS3(url, payload);
    hintEl.innerHTML = "완료 ✅ S3 저장됨<br>" + key;
  } catch (e) {
    hintEl.textContent = "완료 (업로드 실패: " + e.message + ")";
  }

  logEl.textContent = JSON.stringify(payload, null, 2);
}

// =========================
// 이벤트
// =========================
startBtn.onclick = () => {
  State.block = 1;
  State.trial = 0;
  State.trials = [];
  State.phase = "running";
  respBtn.disabled = false;
  hintEl.textContent = "시작";
  nextTrial();
};

respBtn.onclick = recordResponse;

window.addEventListener("keydown", e => {
  if (e.code === "Space") recordResponse();
});
</script>

</body>
</html>
