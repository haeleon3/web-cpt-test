<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Web CPT</title>
  <style>
    :root{
      --bg:#000;
      --panel: rgba(255,255,255,0.10);
      --panelStroke: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --tap:#e53935;
      --tapText:#fff;
      --card: rgba(255,255,255,0.06);
      --cardStroke: rgba(255,255,255,0.10);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; margin:0; background:var(--bg); font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;}
    body{ overflow:hidden; }

    .wrap{ height:100%; display:flex; align-items:center; justify-content:center; padding: env(safe-area-inset-top) 18px env(safe-area-inset-bottom) 18px; }
    .app{ width:min(900px, 100%); display:flex; flex-direction:column; gap:18px; align-items:stretch; }

    .timeRow{ display:flex; justify-content:center; align-items:center; margin-top: 2px; min-height: 34px; }
    .timePill{ display:inline-flex; gap:10px; align-items:center; padding: 8px 14px; border-radius: 999px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); color: rgba(255,255,255,0.9); font-weight: 900; letter-spacing: 0.3px; user-select:none; }
    .timePill .label{ color: rgba(255,255,255,0.70); font-weight: 800; font-size: 13px; }
    .timePill .clock{ font-variant-numeric: tabular-nums; font-size: 18px; }
    .timeRow.hidden { display:none !important; }

    .panel{ width:100%; aspect-ratio: 16 / 8; min-height: 300px; max-height: 420px; background: var(--panel); border: 1px solid var(--panelStroke); border-radius: 22px; display:flex; align-items:center; justify-content:center; position:relative; }
    .panelInner{ width: 70%; height: 70%; display:flex; align-items:center; justify-content:center; opacity: 0; transition: opacity 70ms linear; user-select:none; pointer-events:none; }
    .panelInner.show{ opacity: 1; }

    .tap{ width:100%; height: 96px; background: var(--tap); color: var(--tapText); border:none; border-radius: 18px; font-weight: 900; font-size: 30px; letter-spacing: 1px; box-shadow: 0 14px 30px rgba(229,57,53,0.22), inset 0 1px 0 rgba(255,255,255,0.22); transition: transform 70ms ease, filter 70ms ease, box-shadow 70ms ease; touch-action: manipulation; }
    .tap:disabled{ opacity:0.35; box-shadow: none; }
    .tap.pressed{ transform: translateY(2px) scale(0.995); filter: brightness(0.96); box-shadow: 0 8px 18px rgba(229,57,53,0.18), inset 0 2px 8px rgba(0,0,0,0.25); }

    .overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding: env(safe-area-inset-top) 18px env(safe-area-inset-bottom) 18px; background: rgba(0,0,0,0.72); z-index: 50; }
    .overlay.show{ display:flex; }
    .modal{ width:min(720px, 100%); background: rgba(20,20,20,0.92); border: 1px solid rgba(255,255,255,0.14); border-radius: 18px; padding: 18px; color: var(--text); text-align:center; }
    .modal h2{ margin:0 0 10px 0; font-size: 22px; }
    .modal p{ margin:8px 0; color: var(--muted); line-height: 1.35; font-size: 16px; }
    .modal .row{ display:flex; gap:12px; align-items:center; justify-content:center; margin-top: 20px; flex-wrap:wrap; }
    .btn{ padding: 12px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: var(--text); font-weight: 800; font-size: 16px; cursor:pointer; }
    .btn.primary{ background: rgba(229,57,53,0.92); border-color: rgba(229,57,53,0.92); }
    .btn:disabled{ opacity:0.4; cursor:not-allowed; }

    label{ display:block; margin: 20px 0 8px; font-size: 16px; color: var(--text); }
    select, input[type="number"]{ width:100%; max-width:300px; padding:12px; font-size:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin:0 auto; display:block; }
    .gender-row{ display:flex; gap:20px; justify-content:center; margin:20px 0; flex-wrap:wrap; }
    .gender-row label{ display:flex; align-items:center; gap:8px; font-size:16px; cursor:pointer; }
    .error{ color:#ff6b6b; font-size:14px; margin-top:10px; display:none; }

    .results{ position:fixed; inset:0; background:#0b0b0b; color:var(--text); display:none; overflow:auto; z-index:60; }
    .results.show{ display:block; }
    .results .inner{ width:min(980px,100%); margin:0 auto; padding: env(safe-area-inset-top) 16px 22px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; position:sticky; top:0; padding:10px 0; background:linear-gradient(#0b0b0b 80%,rgba(11,11,11,0)); z-index:5; }
    .topbar h1{ margin:0; font-size:22px; }
    .pill{ display:inline-flex; gap:10px; align-items:center; font-weight:800; font-size:13px; color:rgba(255,255,255,0.85); padding:8px 10px; border-radius:999px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.10); }
    .section{ margin-top:14px; padding:14px; background:var(--card); border:1px solid var(--cardStroke); border-radius:14px; }
    .section h3{ margin:0 0 10px 0; font-size:18px; }
    .kv{ display:grid; grid-template-columns:1fr auto; gap:8px 10px; font-size:15px; color:rgba(255,255,255,0.85); }
    .kv div:nth-child(2n){ text-align:right; color:rgba(255,255,255,0.92); font-weight:700; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.35; }
    .bins{ margin-top:10px; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:12.5px; color:rgba(255,255,255,0.72); white-space:pre; overflow:auto; padding:10px; border-radius:12px; background:rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.10); }
    .chartGrid{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; }
    .chartCard{ background:rgba(0,0,0,0.30); border:1px solid rgba(255,255,255,0.10); border-radius:12px; padding:10px; }
    .chartHead{ display:flex; align-items:center; justify-content:space-between; font-size:13px; font-weight:900; color:rgba(255,255,255,0.85); margin-bottom:6px; }
    canvas{ width:100%; height:96px; display:block; border-radius:10px; background:rgba(255,255,255,0.04); }
    .tooltip{ position:fixed; z-index:80; pointer-events:none; display:none; background:rgba(0,0,0,0.72); border:1px solid rgba(255,255,255,0.18); border-radius:10px; padding:8px 10px; color:rgba(255,255,255,0.92); font-size:12px; line-height:1.25; white-space:pre-line; }
    .tooltip.show{ display:block; }

    .startRow{ display:flex; gap:12px; justify-content:center; align-items:center; }
    .hint{ text-align:center; color:var(--muted); font-size:14px; line-height:1.35; margin-top:-4px; }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app">
      <div class="timeRow hidden" id="timeRow">
        <div class="timePill">
          <span class="label">남은 시간</span>
          <span class="clock" id="timeLeft">--:--</span>
        </div>
      </div>
      <div class="panel">
        <div id="stimulus" class="panelInner"></div>
      </div>
      <button id="tapBtn" class="tap" disabled>TAP</button>
      <div class="hint" id="hint">
        Start 후에는 <b>빨간 TAP</b>만 누르세요 (블록 시작 때 규칙 안내가 뜹니다)
      </div>
      <div class="startRow" id="startRow">
        <button id="startBtn" class="btn primary">Start</button>
        <button id="resetBtn" class="btn">Reset</button>
      </div>
    </div>
  </div>

  <!-- Instruction overlay -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <h2 id="ovTitle">규칙</h2>
      <p id="ovBody"></p>
      <p id="ovCountdown" style="font-weight:900;color:rgba(255,255,255,0.9)"></p>
      <div class="row">
        <button id="ovSkip" class="btn">바로 시작</button>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div id="results" class="results">
    <div class="inner">
      <div class="topbar">
        <h1>Results</h1>
        <div style="display:flex;gap:10px;align-items:center;">
          <span id="thrPill" class="pill">Omission threshold: -</span>
          <button id="dlCsv" class="btn">CSV</button>
          <button id="dlJson" class="btn">JSON</button>
          <button id="closeResults" class="btn primary">닫기</button>
        </div>
      </div>
      <div class="section">
        <h3>블록별 요약</h3>
        <div id="blockSummaries" class="muted">-</div>
      </div>
      <div class="section">
        <h3>블록별 15s bin</h3>
        <div id="blockBins" class="muted">-</div>
      </div>
      <div class="section">
        <h3>전체 타임라인 4지표 차트 (15s bin)</h3>
        <div class="muted">터치/드래그하면 해당 bin과 trial 범위를 표시합니다.</div>
        <div class="chartGrid" id="quadCharts"></div>
      </div>
      <div class="section">
        <h3>해석</h3>
        <div class="muted">
          - Omission↑: 타겟 놓침(주의 이탈/각성 저하/지속주의 저하 가능)<br/>
          - Commission↑: 비타겟 반응(억제 실패/충동/규칙 유지 실패)<br/>
          - MeanRT↑: 처리속도 저하/조심모드/각성 저하 가능<br/>
          - RTV↑: 반응 일관성 붕괴(주의 변동/피로/압박 민감)<br/>
          - Anticipatory↑: 성급/예측반응 신호
        </div>
      </div>
      <div style="height:22px"></div>
    </div>
  </div>

  <!-- 완료 후 정보 입력 모달 -->
  <div id="finishModal" class="overlay">
    <div class="modal">
      <h2>테스트 완료!</h2>
      <p>기본 정보를 입력해주세요. (필수)</p>

      <label for="ageSelect">나이</label>
      <select id="ageSelect" required>
        <option value="">선택하세요</option>
        <option value="10-19">10~19세</option>
        <option value="20-29">20~29세</option>
        <option value="30-39">30~39세</option>
        <option value="40-49">40~49세</option>
        <option value="50-59">50~59세</option>
        <option value="60+">60세 이상</option>
      </select>

      <label>성별</label>
      <div class="gender-row">
        <label><input type="radio" name="gender" value="male" required> 남성</label>
        <label><input type="radio" name="gender" value="female"> 여성</label>
        <label><input type="radio" name="gender" value="none"> 선택안함</label>
      </div>

      <div class="error" id="finishError">모든 항목을 입력해주세요.</div>

      <div class="row">
        <button id="submitFinish" class="btn primary" disabled>결과 확인하기</button>
      </div>
    </div>
  </div>

  <div id="tooltip" class="tooltip"></div>

<script>
(() => {
  // =========================================================
  // Config & State
  // =========================================================
  const CFG = {
    stimOnMs: 180,
    dur: { b0: 60, b1: 120, b2: 120, b3: 180, b4: 60 },
    instructionSec: 10,
    isiFixedMin: 1000,
    isiFixedMax: 1600,
    isiB2: { pre: [1000, 1600], mid: [700, 1100], post: [1000, 1600] },
    baselineMinN: 30,
    omissionAddMs: 250,
    omissionCapMs: 1200,
    omissionFallbackMs: 1100,
    anticipatoryMs: 150,
    binSec: 15,
    invalid: { minTargets: 12, hitRateBelow: 0.20, commissionRateAbove: 0.60 }
  };

  const State = {
    phase: "idle",
    block: null,
    blockStartTs: 0,
    blockTimerId: null,
    stimTimeoutId: null,
    nextStimTimeoutId: null,
    lastPresentedTs: 0,
    awaitingTrialId: null,
    trialIndexInBlock: 0,
    trials: [],
    baselineRTs: [],
    omissionThresholdMs: CFG.omissionFallbackMs,
    hasAnyData: false,
    testStartTs: 0,
    testTotalPlannedSec: 0,
    testTickerId: null,
  };

  // =========================================================
  // DOM
  // =========================================================
  const stimulusEl = document.getElementById("stimulus");
  const tapBtn = document.getElementById("tapBtn");
  const startBtn = document.getElementById("startBtn");
  const resetBtn = document.getElementById("resetBtn");
  const hintEl = document.getElementById("hint");
  const startRow = document.getElementById("startRow");
  const overlay = document.getElementById("overlay");
  const ovTitle = document.getElementById("ovTitle");
  const ovBody = document.getElementById("ovBody");
  const ovCountdown = document.getElementById("ovCountdown");
  const ovSkip = document.getElementById("ovSkip");
  const results = document.getElementById("results");
  const closeResults = document.getElementById("closeResults");
  const blockSummaries = document.getElementById("blockSummaries");
  const blockBins = document.getElementById("blockBins");
  const quadCharts = document.getElementById("quadCharts");
  const thrPill = document.getElementById("thrPill");
  const dlCsv = document.getElementById("dlCsv");
  const dlJson = document.getElementById("dlJson");
  const tooltip = document.getElementById("tooltip");
  const timeRow = document.getElementById("timeRow");
  const timeLeftEl = document.getElementById("timeLeft");

  // 완료 모달
  const finishModal = document.getElementById("finishModal");
  const ageSelect = document.getElementById("ageSelect");
  const genderRadios = document.querySelectorAll('input[name="gender"]');
  const submitFinishBtn = document.getElementById("submitFinish");
  const finishError = document.getElementById("finishError");

  // =========================================================
  // Utils (기존 그대로)
  // =========================================================
  const nowMs = () => performance.now();
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const randi = (a,b)=>Math.floor(a + Math.random()*(b-a+1));
  const mean = (arr)=> arr.reduce((s,x)=>s+x,0)/arr.length;
  const std = (arr)=>{
    if(arr.length<2) return null;
    const m=mean(arr);
    const v=arr.reduce((s,x)=>s+(x-m)*(x-m),0)/(arr.length-1);
    return Math.sqrt(v);
  };
  const percentile = (xs, p)=>{
    if(xs.length===0) return null;
    const s = [...xs].sort((a,b)=>a-b);
    if(s.length===1) return s[0];
    const pp = clamp(p,0,1);
    const idx = (s.length-1)*pp;
    const lo = Math.floor(idx), hi = Math.ceil(idx);
    if(lo===hi) return s[lo];
    const w = idx-lo;
    return s[lo]*(1-w) + s[hi]*w;
  };
  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtMMSS(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${pad2(m)}:${pad2(s)}`;
  }

  function syncStartRowVisibility(){
    const show = (State.phase === "idle");
    startRow.classList.toggle("hidden", !show);
  }

  function syncTimeRowVisibility(){
    const show = (State.phase !== "idle");
    timeRow.classList.toggle("hidden", !show);
  }

  // Shapes, blockRuleText, makeStimulus, isiFor, newTrial, stopAllTimers 등은 그대로 유지 (생략)

  // =========================================================
  // S3 업로드 함수
  // =========================================================
  const API_ENDPOINT = '/api/get-presigned-url';

  async function submitResultsToS3() {
    const age = ageSelect.value;
    const gender = document.querySelector('input[name="gender"]:checked')?.value;

    if (!age || !gender) {
      finishError.style.display = 'block';
      return false;
    }

    finishError.style.display = 'none';

    const payload = {
      submittedAt: new Date().toISOString(),
      ageGroup: age,
      gender: gender,
      omissionThresholdMs: State.omissionThresholdMs,
      cfg: CFG,
      trials: State.trials
    };

    try {
      const res = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contentType: 'application/json' })
      });

      if (!res.ok) throw new Error(`Presigned URL 요청 실패: ${res.status}`);

      const { url } = await res.json();

      const uploadRes = await fetch(url, {
        method: 'PUT',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'application/json' }
      });

      if (!uploadRes.ok) throw new Error(`S3 업로드 실패: ${uploadRes.status}`);

      alert("결과가 서버에 저장되었습니다!");
      return true;
    } catch (err) {
      console.error("업로드 오류:", err);
      alert("저장에 실패했습니다.\n인터넷 연결을 확인해주세요.");
      return false;
    }
  }

  // =========================================================
  // 완료 모달 제어
  // =========================================================
  function showFinishModal() {
    finishModal.classList.add("show");
    submitFinishBtn.disabled = true;
    finishError.style.display = 'none';

    const checkInputs = () => {
      const age = ageSelect.value;
      const gender = document.querySelector('input[name="gender"]:checked');
      submitFinishBtn.disabled = !(age && gender);
    };

    ageSelect.addEventListener('change', checkInputs);
    genderRadios.forEach(r => r.addEventListener('change', checkInputs));

    submitFinishBtn.onclick = async () => {
      const success = await submitResultsToS3();
      if (success) {
        finishModal.classList.remove("show");
        renderResults();
        results.classList.add("show");
      }
    };
  }

  // =========================================================
  // finishBlock 수정 (마지막 블록 끝나면 모달 띄움)
  // =========================================================
  function finishBlock(block) {
    stopAllTimers();
    hideStimulus();
    tapBtn.disabled = true;

    if(block===0) computeOmissionThreshold();

    if(block < 4){
      const next = block + 1;
      State.phase = "instruction";
      State.block = next;
      syncStartRowVisibility();
      syncTimeRowVisibility();
      showInstruction(next, ()=> startBlock(next));
    } else {
      State.phase = "finished";
      hintEl.style.display = "block";
      hintEl.innerHTML = `완료 ✅ 정보를 입력해주세요`;
      syncStartRowVisibility();
      syncTimeRowVisibility();

      // 기존 Results 버튼 숨김
      document.getElementById("openResultsBtn")?.style.display = "none";

      // 완료 모달 열기
      showFinishModal();
    }
  }

  // =========================================================
  // Initial & Event wiring
  // =========================================================
  resetAll();

  // Start 버튼 이벤트 (강제 재설정)
  startBtn.onclick = () => {
    if (State.phase === "running") return;
    startSequence();
  };

  resetBtn.onclick = () => resetAll();

  // 나머지 이벤트 (tapBtn, ovSkip 등)은 그대로 유지

  // window load 시 버튼 초기화 (필요시)
  window.addEventListener('load', () => {
    // 필요하면 추가 UI 조정
  });

})();
</script>
</body>
</html>
