<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Web CPT</title>
  <style>
    :root{
      --bg:#000;
      --panel: rgba(255,255,255,0.10);
      --panelStroke: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --tap:#e53935;
      --tapText:#fff;
      --card: rgba(255,255,255,0.06);
      --cardStroke: rgba(255,255,255,0.10);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; margin:0; background:var(--bg); font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;}
    body{ overflow:hidden; }

    .wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: env(safe-area-inset-top) 18px env(safe-area-inset-bottom) 18px;
    }
    .app{
      width:min(900px, 100%);
      display:flex;
      flex-direction:column;
      gap:18px;
      align-items:stretch;
    }

    /* ======= Global remaining time pill ======= */
    .timeRow{
      display:flex;
      justify-content:center;
      align-items:center;
      margin-top: 2px;
      min-height: 34px;
    }
    .timePill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.9);
      font-weight: 900;
      letter-spacing: 0.3px;
      user-select:none;
    }
    .timePill .label{
      color: rgba(255,255,255,0.70);
      font-weight: 800;
      font-size: 13px;
    }
    .timePill .clock{
      font-variant-numeric: tabular-nums;
      font-size: 18px;
    }
    .timeRow.hidden { display:none !important; }

    /* stimulus panel */
    .panel{
      width:100%;
      aspect-ratio: 16 / 8;
      min-height: 300px;
      max-height: 420px;
      background: var(--panel);
      border: 1px solid var(--panelStroke);
      border-radius: 22px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .panelInner{
      width: 70%;
      height: 70%;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity: 0;
      transition: opacity 70ms linear;
      user-select:none;
      pointer-events:none;
    }
    .panelInner.show{ opacity: 1; }

    /* TAP button */
    .tap{
      width:100%;
      height: 96px;
      background: var(--tap);
      color: var(--tapText);
      border:none;
      border-radius: 18px;
      font-weight: 900;
      font-size: 30px;
      letter-spacing: 1px;
      box-shadow:
        0 14px 30px rgba(229,57,53,0.22),
        inset 0 1px 0 rgba(255,255,255,0.22);
      transition: transform 70ms ease, filter 70ms ease, box-shadow 70ms ease;
      touch-action: manipulation;
    }
    .tap:disabled{
      opacity:0.35;
      box-shadow: none;
    }
    /* pressed feedback: 확실하게 */
    .tap.pressed{
      transform: translateY(2px) scale(0.995);
      filter: brightness(0.96);
      box-shadow:
        0 8px 18px rgba(229,57,53,0.18),
        inset 0 2px 8px rgba(0,0,0,0.25);
    }

    /* overlay screens */
    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: env(safe-area-inset-top) 18px env(safe-area-inset-bottom) 18px;
      background: rgba(0,0,0,0.72);
      z-index: 50;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(720px, 100%);
      background: rgba(20,20,20,0.92);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 18px;
      padding: 18px;
      color: var(--text);
    }
    .modal h2{
      margin:0 0 10px 0;
      font-size: 22px;
    }
    .modal p{
      margin:8px 0;
      color: var(--muted);
      line-height: 1.35;
      white-space: pre-line;
      font-size: 16px;
    }
    .modal .row{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:flex-end;
      margin-top: 14px;
    }
    .btn{
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      font-weight: 800;
      font-size: 16px;
    }
    .btn.primary{
      background: rgba(229,57,53,0.92);
      border-color: rgba(229,57,53,0.92);
    }

    /* results */
    .results{
      position:fixed;
      inset:0;
      background:#0b0b0b;
      color:var(--text);
      display:none;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      z-index: 60;
    }
    .results.show{ display:block; }
    .results .inner{
      width:min(980px, 100%);
      margin: 0 auto;
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 22px 16px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position: sticky;
      top: 0;
      padding: 10px 0;
      background: linear-gradient(#0b0b0b 80%, rgba(11,11,11,0));
      z-index: 5;
    }
    .topbar h1{
      margin:0;
      font-size: 22px;
    }
    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      font-weight: 800;
      font-size: 13px;
      color: rgba(255,255,255,0.85);
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .section{
      margin-top: 14px;
      padding: 14px;
      background: var(--card);
      border: 1px solid var(--cardStroke);
      border-radius: 14px;
    }
    .section h3{
      margin: 0 0 10px 0;
      font-size: 18px;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px 10px;
      font-size: 15px;
      color: rgba(255,255,255,0.85);
    }
    .kv div:nth-child(2n){
      text-align:right;
      color: rgba(255,255,255,0.92);
      font-weight: 700;
    }
    .muted{ color: var(--muted); font-size: 13px; line-height: 1.35; }
    .bins{
      margin-top: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12.5px;
      color: rgba(255,255,255,0.72);
      white-space: pre;
      overflow:auto;
      padding: 10px;
      border-radius: 12px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .chartGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .chartCard{
      background: rgba(0,0,0,0.30);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px;
    }
    .chartHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size: 13px;
      font-weight: 900;
      color: rgba(255,255,255,0.85);
      margin-bottom: 6px;
    }
    canvas{ width:100%; height: 96px; display:block; border-radius: 10px; background: rgba(255,255,255,0.04); }
    .tooltip{
      position: fixed;
      z-index: 80;
      pointer-events:none;
      display:none;
      background: rgba(0,0,0,0.72);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 10px;
      padding: 8px 10px;
      color: rgba(255,255,255,0.92);
      font-size: 12px;
      line-height: 1.25;
      white-space: pre-line;
    }
    .tooltip.show{ display:block; }

    /* start screen mini */
    .startRow{
      display:flex;
      gap:12px;
      justify-content:center;
      align-items:center;
    }
    .hint{
      text-align:center;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.35;
      margin-top: -4px;
    }
    /* visibility helper */
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app">
      <!-- 전체 남은시간 (idle 때는 숨김) -->
      <div class="timeRow hidden" id="timeRow">
        <div class="timePill">
          <span class="label">남은 시간</span>
          <span class="clock" id="timeLeft">--:--</span>
        </div>
      </div>
      <!-- Stimulus panel -->
      <div class="panel">
        <div id="stimulus" class="panelInner">
          <!-- SVG inserted here -->
        </div>
      </div>
      <!-- Controls -->
      <button id="tapBtn" class="tap" disabled>TAP</button>
      <div class="hint" id="hint">
        Start 후에는 <b>빨간 TAP</b>만 누르세요 (블록 시작 때 규칙 안내가 뜹니다)
      </div>
      <!-- idle에서만 보이게 -->
      <div class="startRow" id="startRow">
        <button id="startBtn" class="btn primary">Start</button>
        <button id="openResultsBtn" class="btn" disabled>Results</button>
        <button id="resetBtn" class="btn">Reset</button>
      </div>
    </div>
  </div>
  <!-- Instruction overlay -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <h2 id="ovTitle">규칙</h2>
      <p id="ovBody"></p>
      <p id="ovCountdown" style="font-weight:900;color:rgba(255,255,255,0.9)"></p>
      <div class="row">
        <button id="ovSkip" class="btn">바로 시작</button>
      </div>
    </div>
  </div>
  <!-- Results -->
  <div id="results" class="results">
    <div class="inner">
      <div class="topbar">
        <h1>Results</h1>
        <div style="display:flex;gap:10px;align-items:center;">
          <span id="thrPill" class="pill">Omission threshold: -</span>
          <button id="dlCsv" class="btn">CSV</button>
          <button id="dlJson" class="btn">JSON</button>
          <button id="s3UploadBtn" class="btn primary">결과 전송 (S3 저장)</button>
          <button id="closeResults" class="btn primary">닫기</button>
        </div>
      </div>
      <div class="section">
        <h3>블록별 요약</h3>
        <div id="blockSummaries" class="muted">-</div>
      </div>
      <div class="section">
        <h3>블록별 15s bin</h3>
        <div id="blockBins" class="muted">-</div>
      </div>
      <div class="section">
        <h3>전체 타임라인 4지표 차트 (15s bin)</h3>
        <div class="muted">터치/드래그하면 해당 bin과 trial 범위를 표시합니다.</div>
        <div class="chartGrid" id="quadCharts"></div>
      </div>
      <div class="section">
        <h3>해석(고정 문구)</h3>
        <div class="muted">
          - Omission↑: 타겟 놓침(주의 이탈/각성 저하/지속주의 저하 가능)<br/>
          - Commission↑: 비타겟 반응(억제 실패/충동/규칙 유지 실패)<br/>
          - MeanRT↑: 처리속도 저하/조심모드/각성 저하 가능<br/>
          - RTV↑: 반응 일관성 붕괴(주의 변동/피로/압박 민감)<br/>
          - Anticipatory↑: 성급/예측반응 신호
        </div>
      </div>
      <div style="height:22px"></div>
    </div>
  </div>
  <div id="tooltip" class="tooltip"></div>

<script>
(() => {
  // ... 네 원본 스크립트 전체 그대로 (CFG, State, DOM, Utils, svgShape, blockRuleText, makeStimulus, isiFor, newTrial, stopAllTimers, totalPlannedSec, startGlobalTimer, resetAll, startSequence, showInstruction, startBlock, blockDurSec, scheduleNextStimulus, presentStimulus, finishBlock, pressedFlash, handleTap, finalizeOmissionIfNeeded, computeOmissionThreshold, summarizeBlock, invalidState, summarizeBinsForBlock, blockOffsetSec, summarizeGlobalBins, renderResults, drawLineChart, attachCrosshair, trialsToCSV, downloadText 등)

  // =========================================================
  // S3 업로드 추가 (Vercel presigned URL 방식)
  // =========================================================
  const API_ENDPOINT = '/api/get-presigned-url';

  async function uploadToS3() {
    if (State.trials.length === 0) {
      alert("데이터가 없습니다.");
      return;
    }

    const payload = {
      submittedAt: new Date().toISOString(),
      omissionThresholdMs: State.omissionThresholdMs,
      cfg: CFG,
      trials: State.trials
    };

    try {
      // presigned URL 받기
      const res = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contentType: 'application/json' })
      });

      if (!res.ok) {
        throw new Error(`Presigned URL 요청 실패: ${res.status}`);
      }

      const { url } = await res.json();

      // S3에 PUT
      const uploadRes = await fetch(url, {
        method: 'PUT',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'application/json' }
      });

      if (!uploadRes.ok) {
        throw new Error(`S3 업로드 실패: ${uploadRes.status}`);
      }

      alert("결과가 S3에 저장되었습니다!");
    } catch (err) {
      console.error("업로드 오류:", err);
      alert("전송 실패: " + err.message + "\n콘솔(F12) 확인해주세요.");
    }
  }

  // =========================================================
  // Results 화면에 "결과 전송" 버튼 추가
  // =========================================================
  function addS3UploadButton() {
    const topbarButtons = document.querySelector('.topbar > div[style*="display:flex"]');
    if (topbarButtons && !document.getElementById('s3UploadBtn')) {
      const btn = document.createElement('button');
      btn.id = 's3UploadBtn';
      btn.className = 'btn primary';
      btn.textContent = '결과 전송 (S3 저장)';
      btn.onclick = uploadToS3;
      topbarButtons.insertBefore(btn, dlCsv);
    }
  }

  // renderResults 호출 시 버튼 추가
  const originalRenderResults = renderResults;
  renderResults = function() {
    originalRenderResults();
    addS3UploadButton();
  };

  // =========================================================
  // Event wiring (기존 그대로 + Results 버튼 활성화 강화)
  // =========================================================
  tapBtn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); handleTap(); }, {passive:false});
  tapBtn.addEventListener("touchstart",  (e)=>{ e.preventDefault(); handleTap(); }, {passive:false});

  tapBtn.addEventListener("pointerdown", ()=>{ if(!tapBtn.disabled) tapBtn.classList.add("pressed"); }, {passive:true});
  tapBtn.addEventListener("pointerup",   ()=>tapBtn.classList.remove("pressed"), {passive:true});
  tapBtn.addEventListener("pointercancel",()=>tapBtn.classList.remove("pressed"), {passive:true});
  tapBtn.addEventListener("touchend",    ()=>tapBtn.classList.remove("pressed"), {passive:true});
  tapBtn.addEventListener("touchcancel", ()=>tapBtn.classList.remove("pressed"), {passive:true});

  startBtn.onclick = () => {
    if(State.phase==="running") return;
    startSequence();
  };

  resetBtn.onclick = () => resetAll();

  openResultsBtn.onclick = () => {
    if(!State.hasAnyData) return;
    renderResults();
    results.classList.add("show");
  };

  closeResults.onclick = () => results.classList.remove("show");

  dlCsv.onclick = () => downloadText("cpt_trials.csv", trialsToCSV());
  dlJson.onclick = () => downloadText("cpt_trials.json", JSON.stringify({
    omissionThresholdMs: State.omissionThresholdMs,
    cfg: CFG,
    trials: State.trials
  }, null, 2));

  // =========================================================
  // Initial
  // =========================================================
  resetAll();

  // finishBlock에서 Results 버튼 강제 활성화
  const originalFinishBlock = finishBlock;
  finishBlock = function(block) {
    originalFinishBlock(block);
    if (State.phase === "finished") {
      openResultsBtn.disabled = false;
      openResultsBtn.style.opacity = '1';
      openResultsBtn.style.cursor = 'pointer';
    }
  };
})();
</script>
</body>
</html>
